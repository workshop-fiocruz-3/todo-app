name: Laravel CI/CD (Self-Hosted)
 
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  # ===============================
  #  BUILD
  # ===============================
  
  build:
    runs-on: [self-hosted,NEW-VM] 
 
    steps:
      - uses: actions/checkout@v4
 
      # ✅ Passo 4 — Verificação do Composer no PATH
      - name: Verificar Composer no ambiente
        run: |
          echo "Verificando Composer no runner..."
          echo "PATH atual: $PATH"
          which composer || echo "Composer não encontrado"
          composer --version || echo "Composer não disponível"
 
      # ✅ Passo 3 — Usar caminho absoluto do Composer
      - name: Instalar dependências
        run: |
          # Use o caminho completo para o Composer.
          # Se necessário, troque /usr/local/bin/composer por /usr/bin/composer
          /usr/local/bin/composer install --no-interaction --no-progress --prefer-dist
 
          cp .env.example .env || true
          php artisan key:generate || true
          php artisan config:cache || true
          php artisan route:cache || true
          php artisan view:cache || true
  # ===============================
  #  QUALIDADE
  # ===============================
  quality:
    runs-on: self-hosted
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Testes e análise
        run: |
          vendor/bin/phpunit --colors=always || true
          vendor/bin/phpstan analyse --no-progress || true
          vendor/bin/phpcs --standard=PSR12 app/ || true
  # ===============================
  #  DEPLOY
  # ===============================
  deploy:
    runs-on: self-hosted
    needs: quality
    steps:
      - uses: actions/checkout@v4
      - name: Deploy local
        run: |
          echo "Iniciando deploy"
          
          # Ajustar permissões após deploy
          sudo chown -R git-runner:nginx /srv/apps/todo-app/storage /srv/apps/todo-app/bootstrap/cache
          sudo chmod -R 775 /srv/apps/todo-app/storage /srv/apps/todo-app/bootstrap/cache
 
          # Sincronizar código mantendo permissões e ignorando pastas críticas
          find /srv/apps/todo-app -mindepth 1 \
           ! -path '/srv/apps/todo-app/storage/*' \
           ! -path '/srv/apps/todo-app/bootstrap/cache/*' \
           -exec rm -rf {} +
          cp -a ./ /srv/apps/todo-app
 
          # Reconstruir cache do Laravel
          cd /srv/apps/todo-app
          /usr/local/bin/composer install --no-interaction --no-progress --prefer-dist --optimize-autoloader
          php artisan config:cache || true
          php artisan route:cache || true
          php artisan view:cache || true
 
          echo "✅ Deploy finalizado com sucesso"
