name: Deploy Laravel App

on:
  push:
    branches:
      - main   # ou altere para a branch principal do seu projeto

jobs:
  deploy:
    name: Deploy Laravel App (Self-Hosted)
    runs-on: self-hosted

    steps:
      # 1ï¸âƒ£ Faz checkout do cÃ³digo fonte
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Mostra o diretÃ³rio atual (debug opcional)
      - name: Mostrar diretÃ³rio atual
        run: pwd

      # 3ï¸âƒ£ Cria o diretÃ³rio do deploy e ajusta permissÃµes
      - name: Criar diretÃ³rio do deploy
        run: |
          echo "ğŸ”§ Criando diretÃ³rio de destino..."
          sudo mkdir -p /srv/apps/todo-app/public
          sudo chown -R git-runner:git-runner /srv/apps
          echo "âœ… DiretÃ³rio pronto em /srv/apps/todo-app/public"

      # 4ï¸âƒ£ Instala dependÃªncias PHP (Composer)
      - name: Instalar dependÃªncias PHP
        run: |
          echo "ğŸ“¦ Instalando dependÃªncias do Laravel..."
          composer install --no-interaction --no-progress --prefer-dist
          echo "âœ… DependÃªncias instaladas com sucesso!"

      # 5ï¸âƒ£ Copia arquivos para o servidor com rsync
      - name: Fazer deploy com rsync
        run: |
          echo "ğŸš€ Iniciando deploy..."
          rsync -avz --delete ./ /srv/apps/todo-app/public
          echo "âœ… Deploy concluÃ­do!"

      # 6ï¸âƒ£ Configura ambiente Laravel (caso exista o .env)
      - name: Configurar ambiente Laravel
        run: |
          echo "âš™ï¸ Configurando ambiente Laravel..."
          if [ -f /srv/apps/todo-app/public/.env ]; then
            echo "âœ… Arquivo .env encontrado"
          else
            echo "âš ï¸ Nenhum .env encontrado â€” certifique-se de criÃ¡-lo!"
          fi

      # 7ï¸âƒ£ Otimiza a aplicaÃ§Ã£o Laravel (cache)
      - name: Otimizar Laravel
        run: |
          cd /srv/apps/todo-app/public
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          echo "âœ¨ Laravel otimizado com sucesso!"

      # 8ï¸âƒ£ Reinicia os serviÃ§os web (Nginx e PHP-FPM)
      - name: Reiniciar serviÃ§os
        run: |
          echo "ğŸ” Reiniciando Nginx e PHP-FPM..."
          sudo systemctl restart nginx
          sudo systemctl restart php-fpm
          echo "âœ… ServiÃ§os reiniciados com sucesso!"
